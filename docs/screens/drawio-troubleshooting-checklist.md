# draw.ioファイル エラー回避チェックリスト

## 概要

draw.ioファイル（`.drawio`）を作成・編集する際に、エラーを避けるためのチェックリストです。
特にCursorのdraw.io Integrationアドオンで開く際に注意すべき点をまとめています。

## チェックリスト

### 1. XML構造の基本チェック

- [ ] **XMLコメントを削除**
  - `<!-- コメント -->` 形式のコメントは削除する
  - draw.io Integrationアドオンがコメントを正しく処理できない場合がある

- [ ] **XMLの開始タグと終了タグが正しく対応している**
  - すべてのタグが適切に閉じられているか確認
  - ネストが正しいか確認

- [ ] **文字エンコーディングがUTF-8**
  - 日本語を含む場合は特に重要
  - BOMなしUTF-8を推奨

### 2. mxfile要素の必須属性

- [ ] **`host`属性が存在する**
  - 例: `host="app.diagrams.net"`

- [ ] **`modified`属性が存在する**
  - 例: `modified="2024-01-01T00:00:00.000Z"`
  - ISO 8601形式の日時

- [ ] **`agent`属性が存在する**
  - 例: `agent="5.0"`

- [ ] **`version`属性が存在する**
  - 例: `version="21.0.0"`

- [ ] **`etag`属性が存在する**
  - 例: `etag="test"`

- [ ] **`type`属性が存在する**
  - 例: `type="device"`

### 3. mxGraphModel要素のチェック

- [ ] **必須属性がすべて含まれている**
  - `dx`, `dy`, `grid`, `gridSize`, `guides`, `tooltips`, `connect`, `arrows`, `fold`, `page`, `pageScale`, `pageWidth`, `pageHeight`, `math`, `shadow`

- [ ] **数値属性が正しい形式**
  - すべて数値または"0"/"1"の文字列

### 4. root要素とmxCell要素のチェック

- [ ] **root要素が存在する**
  - `<root>` タグが存在する

- [ ] **基本のmxCell要素が存在する**
  - `id="0"` のmxCellが存在する
  - `id="1" parent="0"` のmxCellが存在する

- [ ] **すべてのmxCellにid属性がある**
  - 一意のIDが設定されている

- [ ] **すべてのmxCellにparent属性がある**
  - 親要素が正しく指定されている

### 5. vertex要素（ボックス）のチェック

- [ ] **vertex属性が"1"に設定されている**
  - 例: `vertex="1"`

- [ ] **mxGeometry要素が存在する**
  - `x`, `y`, `width`, `height` がすべて指定されている
  - `as="geometry"` 属性がある

- [ ] **style属性が正しい形式**
  - セミコロン区切りのキー=値のペア
  - 例: `style="rounded=1;whiteSpace=wrap;html=1;"`

### 6. edge要素（矢印・接続線）のチェック

- [ ] **edge属性が"1"に設定されている**
  - 例: `edge="1"`

- [ ] **source属性とtarget属性が存在する**
  - 接続元と接続先のIDが正しく指定されている
  - 例: `source="app" target="auth-check-top"`

- [ ] **mxGeometry要素が存在し、適切に設定されている**
  - `x="0" y="0"` が設定されている
  - `width` と `height` が設定されている
  - `relative="1"` が設定されている
  - `as="geometry"` 属性がある

- [ ] **mxPoint要素（offset）が存在する**
  - `<mxPoint as="offset" />` が含まれている
  - 複雑な接続線の場合は、`sourcePoint` と `targetPoint` も含める

### 7. 値のチェック

- [ ] **nullやundefinedの値がない**
  - すべての属性に値が設定されている
  - 空文字列でも可（`value=""`）

- [ ] **数値が文字列として正しく記述されている**
  - 例: `x="480"` ではなく `x="480"`（文字列）

- [ ] **色コードが正しい形式**
  - 例: `fillColor=#dae8fc`（#記号を含む）

### 8. 日本語テキストのチェック

- [ ] **日本語が正しくエンコードされている**
  - UTF-8エンコーディング
  - XMLエスケープが不要（通常はそのまま記述可能）

- [ ] **value属性に日本語が含まれる場合、正しく記述されている**
  - 例: `value="ログイン"`

## エラーが発生した場合の対処法

### エラー: "Assertion Failed: Argument is `undefined` or `null`"

1. **mxfile要素の必須属性を確認**
   - `modified`, `agent`, `version`, `etag`, `type` がすべて存在するか

2. **edge要素のgeometryを確認**
   - `x="0" y="0"` が設定されているか
   - `<mxPoint as="offset" />` が含まれているか

3. **すべての属性に値が設定されているか確認**
   - 空の属性や未定義の属性がないか

### エラー: "Cannot open file"

1. **XMLの構文エラーを確認**
   - XMLバリデーターで確認
   - タグの閉じ忘れがないか

2. **ファイルの文字エンコーディングを確認**
   - UTF-8（BOMなし）であることを確認

3. **draw.ioのWeb版で開いてみる**
   - Web版で開ける場合は、ファイル形式は正しい
   - Web版で保存し直すと、互換性が向上する場合がある

### エラー: 日本語が文字化けする

1. **ファイルのエンコーディングをUTF-8に変更**
2. **XMLのエンコーディング宣言を確認**
   - 通常は不要だが、必要に応じて追加

## 推奨事項

### ファイル作成時

1. **draw.ioのWeb版で作成する**
   - 最初から正しい形式で作成される
   - その後、必要に応じて手動編集

2. **Web版で一度開いて保存し直す**
   - 手動で作成したファイルは、Web版で開いて保存し直すと互換性が向上

3. **バックアップを取る**
   - 編集前にバックアップを取る

### ファイル編集時

1. **Web版で編集することを推奨**
   - 最も互換性が高い
   - エラーが発生しにくい

2. **手動編集する場合は慎重に**
   - XMLの構造を理解してから編集
   - 小さな変更から始める

3. **変更後は必ず検証**
   - Web版で開いて確認
   - エラーがないか確認

## 参考情報

### draw.ioの公式ドキュメント

- [draw.io公式サイト](https://www.diagrams.net/)
- [draw.io GitHub](https://github.com/jgraph/drawio)

### XML形式の確認方法

1. **XMLバリデーターを使用**
   - オンラインXMLバリデーターで構文チェック

2. **テキストエディタで確認**
   - タグの対応を確認
   - インデントを整えて可読性を向上

## 備考

- 本チェックリストは、draw.io Integrationアドオンでのエラーを避けるためのものです
- draw.ioのWeb版では、より柔軟にファイルを開くことができます
- エラーが解決しない場合は、Web版での編集を推奨します

