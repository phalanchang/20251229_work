# 10_10_03_act01: 認証状態チェック シーケンス図

## アクション情報

| 項目 | 内容 |
|------|------|
| アクションID | `10_10_03_act01` |
| アクション名 | 認証状態チェック |
| 画面ID | `10_10_03`（保護されたページ） |
| トリガー | ページアクセス時（自動実行） |

## シーケンス図

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Router as ルーター<br/>(認証ガード)
    participant API as バックエンドAPI<br/>(オプション)
    participant Protected as 保護されたページ<br/>(フロントエンド)
    participant Login as ログインページ<br/>(フロントエンド)

    User->>Router: 保護されたページのURLにアクセス<br/>(例: /profile)
    
    Note over Router: 認証状態チェック開始
    
    Router->>Router: 認証トークン確認<br/>(localStorage/sessionStorage)
    
    alt トークン不存在
        Router->>Router: 元のURLを保持<br/>(redirectパラメータ)
        Router->>Login: ログインページにリダイレクト<br/>(/login?redirect=/profile)
        Login->>User: ログインページ表示
    else トークン存在
        opt トークン有効性確認（オプション）
            Router->>API: GET /api/auth/me<br/>(Authorization: Bearer token)
            
            alt トークン無効・期限切れ
                API-->>Router: 401 Unauthorized
                Router->>Router: 元のURLを保持
                Router->>Login: ログインページにリダイレクト<br/>(期限切れ通知)
                Login->>User: ログインページ表示<br/>(期限切れメッセージ)
            else トークン有効
                API-->>Router: 200 OK<br/>{success: true, user: {...}}
                Router->>Protected: ページ表示許可
                Protected->>User: 保護されたページ表示
            end
        else トークン存在のみで許可（簡易チェック）
            Router->>Protected: ページ表示許可
            Protected->>User: 保護されたページ表示
        end
    end
```

## 処理フロー詳細

### 1. ページアクセス
- ユーザーが保護されたページのURLにアクセス
- 例: `/profile`, `/settings`など

### 2. 認証状態チェック（ルーター側）
- ルーター（認証ガード）が認証状態をチェック
- 認証トークンまたはセッションの有効性を確認

### 3. 分岐処理

#### 3.1 トークン不存在
- ログインページにリダイレクト
- 元のURLを`redirect`パラメータとして保持

#### 3.2 トークン存在
- **簡易チェック**: トークンが存在するだけで許可（クライアント側のみ）
- **厳密チェック**: サーバー側でトークンの有効性を確認（推奨）

### 4. ページ表示
- ログイン済みの場合、保護されたページを表示
- 未ログインの場合、ログインページにリダイレクト

## エラーハンドリング

| エラー種別 | 処理 |
|-----------|------|
| 認証トークンが無効 | ログインページにリダイレクト |
| セッション期限切れ | ログインページにリダイレクト（期限切れ通知を表示） |
| ネットワークエラー | 簡易チェックの場合は許可、厳密チェックの場合はエラー処理 |

## 備考

- 認証状態チェックは、ルーター側で自動的に実行される
- セキュリティを考慮し、サーバー側でのトークン有効性確認を推奨
- 簡易チェックは開発時のみ使用し、本番環境では厳密チェックを推奨

