# 画面遷移図

## 1. 概要

本ドキュメントは、ログイン・ログアウト機能に関連する画面遷移を図示します。
ユーザーの操作フローとシステムの動作を視覚的に表現しています。

## 2. 画面遷移図（全体）

```
┌─────────────────────────────────────────────────────────────────┐
│                        アプリケーション                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────┐
        │     認証状態チェック（ルーター）      │
        └─────────────────────────────────────┘
                    │                    │
        ┌───────────┴──────────┐        │
        │                       │        │
   未ログイン              ログイン済み    │
        │                       │        │
        ▼                       ▼        │
┌───────────────┐      ┌──────────────┐ │
│ ログインページ │      │  ダッシュボード │ │
│  (SCR-001)    │      │   (SCR-002)   │ │
└───────────────┘      └──────────────┘ │
        │                       │        │
        │                       │        │
        └───────────┬───────────┘        │
                    │                    │
                    ▼                    │
        ┌───────────────────────┐        │
        │  保護されたページ      │        │
        │    (SCR-003)          │        │
        └───────────────────────┘        │
                    │                    │
                    └────────────────────┘
```

## 3. 詳細な画面遷移フロー

### 3.1 ログインフロー

```
┌─────────────────┐
│  アプリ起動/     │
│  ページアクセス  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 認証状態チェック │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
未ログイン  ログイン済み
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│ログイン  │ │ ダッシュボード│
│ページ   │ │ にリダイレクト│
│表示     │ │              │
└────┬────┘ └──────────────┘
     │
     │ ユーザーが認証情報を入力
     │
     ▼
┌─────────────────┐
│ 入力検証         │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
検証エラー  検証OK
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│エラー    │ │ APIリクエスト│
│表示     │ │ 送信         │
│（同一   │ └──────┬───────┘
│ ページ）│        │
└─────────┘        │
                   ▼
            ┌──────────────┐
            │ 認証処理      │
            └──────┬───────┘
                   │
            ┌──────┴──────┐
            │             │
        認証成功      認証失敗
            │             │
            ▼             ▼
    ┌──────────────┐ ┌──────────────┐
    │ トークン保存  │ │ エラー表示   │
    │ ダッシュボード│ │ （同一ページ）│
    │ にリダイレクト│ └──────────────┘
    └──────────────┘
```

### 3.2 ログアウトフロー

```
┌─────────────────┐
│ 任意のページ     │
│（ログイン済み）  │
└────────┬────────┘
         │
         │ ユーザーがログアウトボタンをクリック
         │
         ▼
┌─────────────────┐
│ ログアウト確認   │
│（オプション）    │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
  キャンセル  確認
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│元のページ│ │ APIリクエスト│
│に戻る   │ │ 送信         │
└─────────┘ └──────┬───────┘
                   │
                   ▼
            ┌──────────────┐
            │ セッション    │
            │ 無効化        │
            └──────┬───────┘
                   │
                   ▼
            ┌──────────────┐
            │ トークン削除  │
            │ ログインページ│
            │ にリダイレクト│
            └──────────────┘
```

### 3.3 保護されたページへのアクセスフロー

```
┌─────────────────┐
│ 保護されたページ │
│ のURLにアクセス  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 認証状態チェック │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
未ログイン  ログイン済み
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│元のURL  │ │ ページを表示 │
│を保持   │ │              │
│ログイン │ └──────────────┘
│ページに │
│リダイレクト│
└────┬────┘
     │
     │ ユーザーがログイン
     │
     ▼
┌─────────────────┐
│ ログイン成功     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 元のページに     │
│ リダイレクト     │
└─────────────────┘
```

### 3.4 セッションタイムアウトフロー

```
┌─────────────────┐
│ ログイン済み     │
│ ページ使用中     │
└────────┬────────┘
         │
         │ 一定時間操作なし
         │
         ▼
┌─────────────────┐
│ セッション       │
│ 有効期限チェック │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
期限切れ  有効
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│期限切れ  │ │ 通常通り使用 │
│通知表示  │ │ 継続         │
│ログイン  │ └──────────────┘
│ページに  │
│リダイレクト│
└─────────┘
```

## 4. 状態遷移図

### 4.1 認証状態の遷移

```
        ┌──────────┐
        │ 未ログイン │
        └────┬─────┘
             │
             │ ログイン成功
             │
             ▼
        ┌──────────┐
        │ログイン済み│
        └────┬─────┘
             │
    ┌────────┼────────┐
    │        │        │
ログアウト  セッション  通常使用
    │        期限切れ   │
    │        │        │
    └────────┴────────┘
             │
             ▼
        ┌──────────┐
        │ 未ログイン │
        └──────────┘
```

### 4.2 ログインページの状態遷移

```
        ┌──────────┐
        │ 初期状態  │
        └────┬─────┘
             │
             │ ユーザー入力
             │
             ▼
        ┌──────────┐
        │ 入力中    │
        └────┬─────┘
             │
    ┌────────┼────────┐
    │        │        │
検証エラー  送信中  送信成功
    │        │        │
    │        │        │
    ▼        ▼        ▼
┌────────┐ ┌────────┐ ┌────────┐
│エラー   │ │ローディ│ │リダイレ│
│表示    │ │ング    │ │クト    │
└────────┘ └────────┘ └────────┘
```

## 5. 画面遷移表

### 5.1 遷移元と遷移先の一覧

| 遷移元画面 | 操作/条件 | 遷移先画面 | 備考 |
|-----------|----------|-----------|------|
| ログインページ | ログイン成功 | ダッシュボード | 元のURLが保持されている場合は元のページへ |
| ログインページ | ログイン失敗 | ログインページ | エラーメッセージ表示 |
| ログインページ | 入力検証エラー | ログインページ | エラーメッセージ表示 |
| ダッシュボード | ログアウト | ログインページ | - |
| 保護されたページ | ログアウト | ログインページ | - |
| 任意のページ | セッション期限切れ | ログインページ | 期限切れ通知表示 |
| 保護されたページ | 未ログインでアクセス | ログインページ | 元のURLを保持 |
| ログインページ | 既ログインでアクセス | ダッシュボード | 自動リダイレクト |

### 5.2 リダイレクト条件

| 条件 | 現在の画面 | 遷移先 | 理由 |
|------|-----------|--------|------|
| 未ログイン | 保護されたページ | ログインページ | 認証が必要 |
| ログイン済み | ログインページ | ダッシュボード | 既に認証済み |
| ログイン成功 | ログインページ | ダッシュボード（または元のページ） | 認証完了 |
| ログアウト成功 | 任意のページ | ログインページ | 認証解除 |
| セッション期限切れ | 任意のページ | ログインページ | 認証無効 |

## 6. URLパラメータとクエリパラメータ

### 6.1 リダイレクト先の保持

**例**: 未ログイン状態で `/profile` にアクセスした場合

```
1. ユーザーが `/profile` にアクセス
2. 認証チェックで未ログインを検出
3. `/login?redirect=/profile` にリダイレクト
4. ログイン成功後、`/profile` にリダイレクト
```

### 6.2 エラーメッセージの表示

**例**: ログイン失敗時にエラーメッセージを表示

```
1. ログイン失敗
2. `/login?error=auth_failed` にリダイレクト（オプション）
3. または、同一ページでエラーメッセージを表示
```

## 7. 画面遷移の実装方針

### 7.1 React Router の使用

- ルート定義で認証状態をチェック
- 保護されたルートには認証ミドルウェアを適用
- リダイレクト処理を実装

### 7.2 認証ガード（AuthGuard）

```javascript
// 疑似コード
<Route 
  path="/protected" 
  element={
    <AuthGuard>
      <ProtectedPage />
    </AuthGuard>
  } 
/>
```

### 7.3 リダイレクト処理

- 未認証アクセス時: ログインページにリダイレクト（元のURLを保持）
- 既認証アクセス時: ダッシュボードにリダイレクト
- ログイン成功時: 元のURLがあればそこへ、なければダッシュボードへ

## 8. エッジケース

### 8.1 複数タブでの操作

- タブAでログアウト → タブBも自動的にログアウト状態に
- タブAでログイン → タブBも自動的にログイン状態に

### 8.2 ネットワークエラー

- APIリクエスト失敗時はエラーメッセージを表示
- リトライ機能を提供（オプション）

### 8.3 ブラウザバック/フォワード

- ブラウザの戻る/進むボタンでも適切に動作
- 認証状態を保持

## 9. 備考

- 本画面遷移図は初期バージョンであり、開発の進行に伴って更新される可能性があります
- 実際の実装では、React Router、Next.js、その他のルーティングライブラリの特性に応じて調整が必要です
- セキュリティを考慮し、クライアント側の認証チェックだけでなく、サーバー側でも認証を検証する必要があります

