# 統合テスト手順書

## 1. テスト環境の準備

### 1.1 サービス起動

```bash
# プロジェクトルートディレクトリに移動
cd 20251229_work

# Docker Composeで全サービスを起動
docker-compose up -d

# ログを確認（正常に起動しているか確認）
docker-compose logs -f
```

### 1.2 テストデータの準備

テストデータのパスワードハッシュを生成する必要があります。

```bash
# バックエンドディレクトリに移動
cd backend

# パスワードハッシュを生成（例: password123）
node scripts/generate-password-hash.js password123

# 生成されたハッシュ値をコピー
# データベースに接続して、テストユーザーのパスワードハッシュを更新
```

または、直接SQLで更新：

```sql
-- テストユーザー1（パスワード: password123）
UPDATE users SET password_hash = '<生成されたハッシュ値>' WHERE email = 'test@example.com';

-- テストユーザー2（パスワード: password123）
UPDATE users SET password_hash = '<生成されたハッシュ値>' WHERE email = 'admin@example.com';
```

### 1.3 アクセス確認

- フロントエンド: http://localhost:3003
- バックエンドAPI: http://localhost:3004/health
- データベース: localhost:3307

## 2. テストシナリオ

### シナリオ1: 正常なログイン

**手順**:
1. ブラウザで http://localhost:3003 にアクセス
2. ログインページが表示されることを確認
3. メールアドレス: `test@example.com` を入力
4. パスワード: `password123` を入力
5. 「ログイン」ボタンをクリック

**期待結果**:
- ログイン成功
- ダッシュボードにリダイレクト
- ユーザー情報が表示される
- ブラウザの開発者ツールでlocalStorageにトークンが保存されていることを確認

### シナリオ2: ログイン失敗（パスワード誤り）

**手順**:
1. ログインページにアクセス
2. メールアドレス: `test@example.com` を入力
3. パスワード: `wrongpassword` を入力
4. 「ログイン」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される（「メールアドレスまたはパスワードが正しくありません」）
- ログインページに留まる
- パスワード入力欄がクリアされる
- メールアドレス入力欄は保持される

### シナリオ3: ログイン失敗（ユーザー不存在）

**手順**:
1. ログインページにアクセス
2. メールアドレス: `nonexistent@example.com` を入力
3. パスワード: `password123` を入力
4. 「ログイン」ボタンをクリック

**期待結果**:
- エラーメッセージが表示される（「メールアドレスまたはパスワードが正しくありません」）
- ログインページに留まる

### シナリオ4: 入力検証エラー

**手順**:
1. ログインページにアクセス
2. メールアドレスを空欄のまま「ログイン」ボタンをクリック

**期待結果**:
- 「メールアドレスを入力してください」というエラーメッセージが表示される
- ログインリクエストが送信されない

**手順**:
1. メールアドレス: `invalid-email` を入力
2. 「ログイン」ボタンをクリック

**期待結果**:
- 「有効なメールアドレス形式で入力してください」というエラーメッセージが表示される

**手順**:
1. メールアドレス: `test@example.com` を入力
2. パスワード: `123` を入力（8文字未満）
3. 「ログイン」ボタンをクリック

**期待結果**:
- 「パスワードは8文字以上で入力してください」というエラーメッセージが表示される

### シナリオ5: ログアウト

**手順**:
1. ログイン成功後、ダッシュボードにいる状態
2. 「ログアウト」ボタンをクリック
3. 確認ダイアログで「OK」をクリック

**期待結果**:
- ログアウト成功
- ログインページにリダイレクト
- localStorageからトークンが削除されていることを確認

### シナリオ6: 保護されたページへのアクセス（認証済み）

**手順**:
1. ログイン成功後、ダッシュボードにいる状態
2. 「保護されたページへ」ボタンをクリック

**期待結果**:
- 保護されたページが表示される
- 認証成功メッセージが表示される
- ユーザー情報が表示される

### シナリオ7: 保護されたページへのアクセス（未認証）

**手順**:
1. ログアウトした状態（または未ログイン状態）
2. ブラウザのアドレスバーに直接 `/protected` を入力してアクセス

**期待結果**:
- 自動的にログインページにリダイレクトされる
- 保護されたページは表示されない

### シナリオ8: ログイン済み状態でログインページにアクセス

**手順**:
1. ログイン成功後、ダッシュボードにいる状態
2. ブラウザのアドレスバーに直接 `/login` を入力してアクセス

**期待結果**:
- 自動的にダッシュボードにリダイレクトされる
- ログインページは表示されない

### シナリオ9: 404エラー

**手順**:
1. ブラウザのアドレスバーに存在しないURL（例: `/nonexistent`）を入力

**期待結果**:
- エラーページにリダイレクトされる
- エラーメッセージが表示される

### シナリオ10: 認証状態確認API

**手順**:
1. ログイン成功後、ブラウザの開発者ツールでlocalStorageからトークンを取得
2. APIクライアント（Postman、curl等）で以下を実行:
   ```
   GET http://localhost:3004/api/auth/me
   Authorization: Bearer <トークン>
   ```

**期待結果**:
- 200 OKレスポンス
- ユーザー情報が返却される

**手順**:
1. 無効なトークンで同じリクエストを実行

**期待結果**:
- 401 Unauthorizedレスポンス
- エラーメッセージが返却される

## 3. チェックリスト

詳細なチェックリストは `docs/test-checklist.md` を参照してください。

## 4. 問題が発生した場合

### 4.1 ログの確認

```bash
# 全サービスのログを確認
docker-compose logs -f

# 特定のサービスのログを確認
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f db
```

### 4.2 データベースの確認

```bash
# データベースに接続
docker-compose exec db mysql -u app_user -papp_password login_app

# ユーザーテーブルの確認
SELECT * FROM users;
```

### 4.3 サービスの再起動

```bash
# 全サービスを再起動
docker-compose restart

# 特定のサービスを再起動
docker-compose restart backend
```

## 5. テスト完了後のクリーンアップ

```bash
# サービスを停止
docker-compose down

# ボリュームも含めて完全に削除（データベースのデータも削除される）
docker-compose down -v
```

