# JWT（JSON Web Token）の仕組みと理解

## ユーザーの理解の確認と補足

### ✅ 正しい理解

1. **ログイン処理の流れ**
   - ユーザーがログイン画面でメールアドレスとパスワードを入力
   - ログインボタンを押下してサーバー側へ処理が遷移
   - サーバー側でDB問い合わせを実施し、正しいIDとパスワード（ハッシュ値）のペアをチェック
   - 正しければJWTトークンを発行

2. **クライアント側の動作**
   - JWTトークンはユーザー側（ブラウザ）で保持
   - 問い合わせのたびにリクエストに付与して送信
   - 通常は `Authorization: Bearer <token>` ヘッダーに含める

### ❌ 誤解がある点

#### 1. サーバー側でトークンを「持っておく」必要はない

**重要なポイント**: JWTは**自己完結型（self-contained）**のトークンです。

- **JWTの特徴**:
  - トークン自体にユーザー情報（userId, emailなど）が含まれている
  - トークンに署名が含まれているため、改ざんを検出できる
  - **サーバー側でトークンを保存する必要がない**

- **現在の実装**:
  ```javascript
  // トークン生成時に、ユーザー情報を含める
  const token = generateToken({
    userId: user.id,
    email: user.email
  });
  // → この情報がトークンに含まれる
  ```

- **トークンの構造**:
  ```
  JWT = Header.Payload.Signature
  
  Payload（中身）:
  {
    "userId": 1,
    "email": "user@example.com",
    "iat": 1234567890,  // 発行時刻
    "exp": 1234654290   // 有効期限
  }
  ```

#### 2. サーバー側でのトークン管理

**JWT方式（現在の実装）**:
- サーバー側でトークンを保存しない
- リクエスト時にトークンを検証するだけ
- メリット: サーバー側の状態管理が不要（スケーラブル）
- デメリット: トークンを無効化できない（有効期限まで有効）

**セッション方式（オプション）**:
- `sessions`テーブルにトークン（またはトークンのハッシュ）を保存
- ログアウト時にテーブルから削除して無効化
- メリット: トークンを即座に無効化できる
- デメリット: サーバー側で状態管理が必要

#### 3. ブラウザでのトークン保存と送信

**保存場所**:
- `localStorage` または `sessionStorage` に保存
- クッキーに保存することも可能（HttpOnlyフラグでセキュアに）

**送信方法**:
- HTTPリクエストの `Authorization` ヘッダーに付与
- 形式: `Authorization: Bearer <JWTトークン>`
- ブラウザが「自動で付与」するのではなく、**アプリケーションコードで手動で付与**する

**実装例（フロントエンド）**:
```javascript
// トークンを保存
localStorage.setItem('token', token);

// APIリクエスト時に付与
fetch('/api/protected', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});
```

## 現在の実装での動作フロー

### 1. ログイン時

```
ユーザー → フロントエンド: メールアドレス・パスワード入力
フロントエンド → バックエンド: POST /api/auth/login {email, password}
バックエンド:
  1. DBからユーザー情報取得
  2. パスワード検証（bcrypt）
  3. JWTトークン生成（userId, emailを含む）
  4. トークンをレスポンスで返却
バックエンド → フロントエンド: {success: true, token: "...", user: {...}}
フロントエンド: localStorageにトークンを保存
```

### 2. 認証が必要なAPIリクエスト時

```
フロントエンド → バックエンド: GET /api/protected
  Headers: { Authorization: "Bearer <JWTトークン>" }
バックエンド:
  1. Authorizationヘッダーからトークンを取得
  2. トークンを検証（署名、有効期限をチェック）
  3. トークンからユーザー情報（userId, email）を取得
  4. 認証OK → 処理を続行
```

### 3. ログアウト時

```
フロントエンド: localStorageからトークンを削除
（サーバー側での処理は不要 - JWT方式の場合）
```

## セッションテーブルの用途（オプション）

`sessions`テーブルは、以下の場合に使用します：

1. **トークンの即座の無効化が必要な場合**
   - ログアウト時にトークンを無効化したい
   - 特定のユーザーの全セッションを無効化したい

2. **セッション管理が必要な場合**
   - アクティブなセッション数を把握したい
   - セッションの有効期限を管理したい

**現在の実装では、JWT方式を採用しているため、sessionsテーブルは使用していません。**

## まとめ

- ✅ JWTトークンはサーバー側で保存する必要がない
- ✅ トークン自体にユーザー情報と有効期限が含まれている
- ✅ サーバー側はトークンを検証するだけで認証できる
- ✅ ブラウザはトークンをlocalStorageに保存し、リクエスト時にAuthorizationヘッダーに付与
- ⚠️ ブラウザが「自動で付与」するのではなく、アプリケーションコードで手動で付与する

